<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Traffic Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 18px; }
    h2 { margin: 0 0 10px; }
    .grid { display: grid; grid-template-columns: repeat(4, 160px); gap: 12px; }
    .lane { padding: 16px; border-radius: 12px; color: #fff; text-align: center; font-size: 18px; }
    .green { background: #22c55e; box-shadow: 0 0 10px rgba(34,197,94,.6); }
    .red { background: #ef4444; }
    .meta { margin: 10px 0; display:flex; gap:8px; flex-wrap:wrap; font-size:16px;}
    .pill { padding:6px 12px; border-radius: 999px; background:#f1f5f9; }
    button { margin: 8px 10px 0 0; padding: 14px 18px; border: 0; border-radius: 12px; background: #334155; color: #fff; cursor: pointer; font-size: 16px; }
    button.secondary { background: #0ea5e9; }
    button.warn { background: #f97316; }
    #timer { font-weight: bold; font-size: 20px; margin-top: 6px; }
  </style>
</head>
<body>
  <h2>ðŸš¦ Smart Traffic Management System</h2>

  <div class="grid">
    <div id="lane0" class="lane red"><strong>Lane A</strong><br/>Cars: <span id="cars0">0</span></div>
    <div id="lane1" class="lane red"><strong>Lane B</strong><br/>Cars: <span id="cars1">0</span></div>
    <div id="lane2" class="lane red"><strong>Lane C</strong><br/>Cars: <span id="cars2">0</span></div>
    <div id="lane3" class="lane red"><strong>Lane D</strong><br/>Cars: <span id="cars3">0</span></div>
  </div>

  <div class="meta">
    <span class="pill">Current green: <span id="currentGreen">â€”</span></span>
    <span class="pill">Emergency lane: <span id="emergencyLane">â€”</span></span>
    <span class="pill">Pedestrian: <span id="pedStatus">â€”</span></span>
    <span class="pill">Timer: <span id="timer">â€”</span> sec</span>
  </div>

  <div>
    <button onclick="setEmergency(0)">ðŸš‘ Ambulance Lane A</button>
    <button onclick="setEmergency(1)">ðŸš‘ Lane B</button>
    <button onclick="setEmergency(2)">ðŸš‘ Lane C</button>
    <button onclick="setEmergency(3)">ðŸš‘ Lane D</button>
    <button class="secondary" onclick="clearEmergency()">âœ… Clear Ambulance</button>
    <button class="warn" onclick="requestPedestrian()">ðŸš¶ Pedestrian Request</button>
  </div>

  <script>
    const laneNames = ["A","B","C","D"];
    let lastSignals = [0,0,0,0];
    let signalStartTime = Date.now();
    let signalDuration = 30; // default cycle time

    async function refresh() {
      try {
        const res = await fetch("/data");
        const data = await res.json();

        // Update cars
        data.vehicles.forEach((v,i)=>{document.getElementById("cars"+i).textContent=v;});

        // Update lane colors
        for(let i=0;i<4;i++){
          const el=document.getElementById("lane"+i);
          el.classList.remove("green","red");
          el.classList.add(data.signals[i]>0?"green":"red");
        }

        // Update info
        let greenLaneText = data.pedestrian.requested
            ? "All Red (Pedestrian)"
            : (data.current_green!==null?"Lane "+laneNames[data.current_green]:"â€”");
        document.getElementById("currentGreen").textContent = greenLaneText;

        document.getElementById("emergencyLane").textContent =
            data.emergency_lane!==null?"Lane "+laneNames[data.emergency_lane]:"â€”";

        document.getElementById("pedStatus").textContent =
            data.pedestrian.requested?"Requested â€¢ waiting/crossing":"Idle";

        // Timer logic
        const activeLane = data.current_green;
        if(activeLane!==null){
          // detect if signals changed
          if(JSON.stringify(data.signals)!==JSON.stringify(lastSignals)){
            signalStartTime = Date.now();
            signalDuration = data.signals[activeLane] || 30;
            lastSignals = data.signals;
          }
          const elapsed = Math.floor((Date.now()-signalStartTime)/1000);
          const remaining = Math.max(signalDuration - elapsed,0);
          document.getElementById("timer").textContent = remaining;
        } else if(data.pedestrian.requested){
          // pedestrian countdown
          const elapsed = Math.floor((Date.now() - (signalStartTime || Date.now()))/1000);
          const remaining = Math.max(15 - elapsed,0);
          document.getElementById("timer").textContent = remaining;
        } else{
          document.getElementById("timer").textContent = "â€”";
        }

      } catch(e){console.error(e);}
    }

    async function setEmergency(lane){
      await fetch("/emergency",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lane})});
      refresh();
    }
    async function clearEmergency(){
      await fetch("/clear_emergency",{method:"POST"});
      refresh();
    }
    async function requestPedestrian(){
      const r=await fetch("/pedestrian",{method:"POST"});
      const {accepted}=await r.json();
      if(!accepted) alert("Pedestrian request ignored (cooldown or already pending).");
      refresh();
    }

    refresh();
    setInterval(refresh,1000);
  </script>
</body>
</html>

<!-- make 2 timers one for the pedestrian and one for signals. also where is the smart scheduling. and yes add the visual effects. also add a timer for how long the pedestrian button cannot be pressed again. add all the visuals required so it is easy to understand and take inference. for that add as many buttons, timers or blocks as needed -->